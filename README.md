<!-- This file was automatically generated by the `geine`. Make all changes to `README.yaml` and run `make readme` to rebuild this file. -->

<p align="center"> <img src="https://user-images.githubusercontent.com/50652676/62349836-882fef80-b51e-11e9-99e3-7b974309c7e3.png" width="100" height="100"></p>


<h1 align="center">
    Terraform AWS EKS
</h1>

<p align="center" style="font-size: 1.2rem;"> 
    Terraform module will be created Autoscaling, Workers, EKS, Node Groups.
     </p>

<p align="center">

<a href="https://www.terraform.io">
  <img src="https://img.shields.io/badge/Terraform-v0.13-green" alt="Terraform">
</a>
<a href="LICENSE.md">
  <img src="https://img.shields.io/badge/License-MIT-blue.svg" alt="Licence">
</a>


</p>
<p align="center">

<a href='https://facebook.com/sharer/sharer.php?u=https://github.com/clouddrove/terraform-aws-eks'>
  <img title="Share on Facebook" src="https://user-images.githubusercontent.com/50652676/62817743-4f64cb80-bb59-11e9-90c7-b057252ded50.png" />
</a>
<a href='https://www.linkedin.com/shareArticle?mini=true&title=Terraform+AWS+EKS&url=https://github.com/clouddrove/terraform-aws-eks'>
  <img title="Share on LinkedIn" src="https://user-images.githubusercontent.com/50652676/62817742-4e339e80-bb59-11e9-87b9-a1f68cae1049.png" />
</a>
<a href='https://twitter.com/intent/tweet/?text=Terraform+AWS+EKS&url=https://github.com/clouddrove/terraform-aws-eks'>
  <img title="Share on Twitter" src="https://user-images.githubusercontent.com/50652676/62817740-4c69db00-bb59-11e9-8a79-3580fbbf6d5c.png" />
</a>

</p>
<hr>


We eat, drink, sleep and most importantly love **DevOps**. We are working towards strategies for standardizing architecture while ensuring security for the infrastructure. We are strong believer of the philosophy <b>Bigger problems are always solved by breaking them into smaller manageable problems</b>. Resonating with microservices architecture, it is considered best-practice to run database, cluster, storage in smaller <b>connected yet manageable pieces</b> within the infrastructure. 

This module is basically combination of [Terraform open source](https://www.terraform.io/) and includes automatation tests and examples. It also helps to create and improve your infrastructure with minimalistic code instead of maintaining the whole infrastructure code yourself.

We have [*fifty plus terraform modules*][terraform_modules]. A few of them are comepleted and are available for open source usage while a few others are in progress.




## Prerequisites

This module has a few dependencies: 

- [Terraform 1.x.x](https://learn.hashicorp.com/terraform/getting-started/install.html)
- [Go](https://golang.org/doc/install)
- [github.com/stretchr/testify/assert](https://github.com/stretchr/testify)
- [github.com/gruntwork-io/terratest/modules/terraform](https://github.com/gruntwork-io/terratest)

- [Kubectl](https://kubernetes.io/docs/tasks/tools/install-kubectl/)
- [AWS IAM Authenticator](https://docs.aws.amazon.com/eks/latest/userguide/install-aws-iam-authenticator.html)







## Examples


**IMPORTANT:** Since the `master` branch used in `source` varies based on new modifications, we suggest that you use the release versions [here](https://github.com/clouddrove/terraform-aws-eks/releases).


### Sample example
Here is an example of how you can use this module in your inventory structure:
```hcl
module "eks" {
source = "clouddrove/eks/aws"
version = "1.0.1"  

name        = "eks"
environment = "test"
label_order = ["environment", "name"]
enabled     = true

kubernetes_version        = "1.25"
endpoint_private_access   = true
endpoint_public_access    = true
enabled_cluster_log_types = ["api", "audit", "authenticator", "controllerManager", "scheduler"]
oidc_provider_enabled     = true

# Network
vpc_id                  = module.vpc.vpc_id
subnet_ids              = module.subnets.private_subnet_id
allowed_security_groups = [module.ssh.security_group_ids]
allowed_cidr_blocks     = ["0.0.0.0/0"]

# Node Groups Defaults Values It will Work all Node Groups
self_node_group_defaults = {
  subnet_ids = module.subnets.private_subnet_id
  key_name   = module.keypair.name
  propagate_tags = [{
    key                 = "aws-node-termination-handler/managed"
    value               = true
    propagate_at_launch = true
    },
    {
      key                 = "autoscaling:ResourceTag/k8s.io/cluster-autoscaler/${module.eks.cluster_id}"
      value               = "owned"
      propagate_at_launch = true
      }
    ]

  block_device_mappings = {
    xvda = {
      device_name = "/dev/xvda"
      ebs = {
        volume_size = 50
        volume_type = "gp3"
        iops        = 3000
        throughput  = 150
        }
      }
    }
  }


self_node_groups = {
  tools = {
    name                 = "tools"
    min_size             = 1
    max_size             = 7
    desired_size         = 2
    bootstrap_extra_args = "--kubelet-extra-args '--max-pods=110'"
    instance_type        = "t3a.medium"
    }

  spot = {
    name = "spot"
    instance_market_options = {
      market_type = "spot"
    }
    min_size             = 1
    max_size             = 7
    desired_size         = 1
    bootstrap_extra_args = "--kubelet-extra-args '--node-labels=node.kubernetes.io/lifecycle=spot'"
    instance_type        = "m5.large"
      }
    }

  # Schdule self Managed Auto Scaling node group
  schedules = {
    scale-up = {
      min_size     = 2
      max_size     = 2 # Retains current max size
      desired_size = 2
      start_time   = "2023-05-15T19:00:00Z"
      end_time     = "2023-05-19T19:00:00Z"
      timezone     = "Europe/Amsterdam"
      recurrence   = "0 7 * * 1"
    },
    scale-down = {
      min_size     = 0
      max_size     = 0 # Retains current max size
      desired_size = 0
      start_time   = "2023-05-12T12:00:00Z"
      end_time     = "2024-03-05T12:00:00Z"
      timezone     = "Europe/Amsterdam"
      recurrence   = "0 7 * * 5"
    }
  }

# Node Groups Defaults Values It will Work all Node Groups
managed_node_group_defaults = {
  subnet_ids                          = module.subnets.private_subnet_id
  key_name                            = module.keypair.name
  nodes_additional_security_group_ids = [module.ssh.security_group_ids]
  tags = {
    Example = "test"
    }

  block_device_mappings = {
    xvda = {
      device_name = "/dev/xvda"
      ebs = {
        volume_size = 50
        volume_type = "gp3"
        iops        = 3000
        throughput  = 150
        }
      }
    }
  }

managed_node_group = {
  test = {
    min_size       = 1
    max_size       = 7
    desired_size   = 2
    instance_types = ["t3a.medium"]
    }

  spot = {
    name          = "spot"
    capacity_type = "SPOT"

    min_size             = 1
    max_size             = 7
    desired_size         = 1
    force_update_version = true
    instance_types       = ["t3.medium", "t3a.medium"]
      }
    }

  apply_config_map_aws_auth = true
  map_additional_iam_users = [
    {
    userarn  = "arn:aws:iam::xxxxxx:user/nikita@clouddrove.com"
    username = "nikita@clouddrove.com"
    groups   = ["system:masters"]
    },
    {
    userarn  = "arn:aws:iam::xxxxxx:user/sohan@clouddrove.com"
    username = "sohan@clouddrove.com"
    groups   = ["system:masters"]
        }
      ]
    # Schdule EKS Managed Auto Scaling node group
    schedules = {
      scale-up = {
        min_size     = 2
        max_size     = 2 # Retains current max size
        desired_size = 2
        start_time   = "2023-05-15T19:00:00Z"
        end_time     = "2023-05-19T19:00:00Z"
        timezone     = "Europe/Amsterdam"
        recurrence   = "0 7 * * 1"
      },
      scale-down = {
        min_size     = 0
        max_size     = 0 # Retains current max size
        desired_size = 0
        start_time   = "2023-05-12T12:00:00Z"
        end_time     = "2024-03-05T12:00:00Z"
        timezone     = "Europe/Amsterdam"
        recurrence   = "0 7 * * 5"
      }
    }        
  }
```






## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| addons | Manages [`aws_eks_addon`](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/eks_addon) resources. | <pre>list(object({<br>    addon_name               = string<br>    addon_version            = string<br>    resolve_conflicts        = string<br>    service_account_role_arn = string<br>  }))</pre> | `[]` | no |
| allowed\_cidr\_blocks | List of CIDR blocks to be allowed to connect to the EKS cluster. | `list(string)` | `[]` | no |
| allowed\_security\_groups | List of Security Group IDs to be allowed to connect to the EKS cluster. | `list(string)` | `[]` | no |
| apply\_config\_map\_aws\_auth | Whether to generate local files from `kubeconfig` and `config_map_aws_auth` and perform `kubectl apply` to apply the ConfigMap to allow the worker nodes to join the EKS cluster. | `bool` | `true` | no |
| attributes | Additional attributes (e.g. `1`). | `list(any)` | `[]` | no |
| aws\_iam\_role\_arn | ARN of EKS iam user | `string` | `""` | no |
| cluster\_create\_timeout | Timeout value when creating the EKS cluster. | `string` | `"30m"` | no |
| cluster\_delete\_timeout | Timeout value when deleting the EKS cluster. | `string` | `"15m"` | no |
| cluster\_encryption\_config\_enabled | Set to `true` to enable Cluster Encryption Configuration | `bool` | `true` | no |
| cluster\_encryption\_config\_kms\_key\_deletion\_window\_in\_days | Cluster Encryption Config KMS Key Resource argument - key deletion windows in days post destruction | `number` | `10` | no |
| cluster\_encryption\_config\_kms\_key\_enable\_key\_rotation | Cluster Encryption Config KMS Key Resource argument - enable kms key rotation | `bool` | `true` | no |
| cluster\_encryption\_config\_kms\_key\_policy | Cluster Encryption Config KMS Key Resource argument - key policy | `string` | `null` | no |
| cluster\_encryption\_config\_resources | Cluster Encryption Config Resources to encrypt, e.g. ['secrets'] | `list(any)` | <pre>[<br>  "secrets"<br>]</pre> | no |
| cluster\_log\_retention\_period | Number of days to retain cluster logs. Requires `enabled_cluster_log_types` to be set. See https://docs.aws.amazon.com/en_us/eks/latest/userguide/control-plane-logs.html. | `number` | `30` | no |
| cluster\_update\_timeout | Timeout value when updating the EKS cluster. | `string` | `"60m"` | no |
| create\_schedule | Determines whether to create autoscaling group schedule or not | `bool` | `true` | no |
| eks\_additional\_security\_group\_ids | EKS additional security group id | `list(string)` | `[]` | no |
| enabled | Whether to create the resources. Set to `false` to prevent the module from creating any resources. | `bool` | `true` | no |
| enabled\_cluster\_log\_types | A list of the desired control plane logging to enable. For more information, see https://docs.aws.amazon.com/en_us/eks/latest/userguide/control-plane-logs.html. Possible values [`api`, `audit`, `authenticator`, `controllerManager`, `scheduler`]. | `list(string)` | `[]` | no |
| endpoint\_private\_access | Indicates whether or not the Amazon EKS private API server endpoint is enabled. Default to AWS EKS resource and it is false. | `bool` | `false` | no |
| endpoint\_public\_access | Indicates whether or not the Amazon EKS public API server endpoint is enabled. Default to AWS EKS resource and it is true. | `bool` | `true` | no |
| environment | Environment (e.g. `prod`, `dev`, `staging`). | `string` | `""` | no |
| kubernetes\_version | Desired Kubernetes master version. If you do not specify a value, the latest available version is used. | `string` | `""` | no |
| label\_order | Label order, e.g. `name`,`application`. | `list(any)` | `[]` | no |
| local\_exec\_interpreter | shell to use for local\_exec | `list(string)` | <pre>[<br>  "/bin/sh",<br>  "-c"<br>]</pre> | no |
| managed\_node\_group | Map of eks-managed node group definitions to create | `any` | `{}` | no |
| managed\_node\_group\_defaults | Map of eks-managed node group definitions to create | `any` | `{}` | no |
| managedby | ManagedBy, eg 'CloudDrove' or 'AnmolNagpal'. | `string` | `"hello@clouddrove.com"` | no |
| map\_additional\_aws\_accounts | Additional AWS account numbers to add to `config-map-aws-auth` ConfigMap | `list(string)` | `[]` | no |
| map\_additional\_iam\_roles | Additional IAM roles to add to `config-map-aws-auth` ConfigMap | <pre>list(object({<br>    rolearn  = string<br>    username = string<br>    groups   = list(string)<br>  }))</pre> | `[]` | no |
| map\_additional\_iam\_users | Additional IAM users to add to `config-map-aws-auth` ConfigMap | <pre>list(object({<br>    userarn  = string<br>    username = string<br>    groups   = list(string)<br>  }))</pre> | `[]` | no |
| name | Name  (e.g. `app` or `cluster`). | `string` | `""` | no |
| nodes\_additional\_security\_group\_ids | EKS additional node group ids | `list(string)` | `[]` | no |
| oidc\_provider\_enabled | Create an IAM OIDC identity provider for the cluster, then you can create IAM roles to associate with a service account in the cluster, instead of using kiam or kube2iam. For more information, see https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html | `bool` | `false` | no |
| openid\_connect\_audiences | List of OpenID Connect audience client IDs to add to the IRSA provider | `list(string)` | `[]` | no |
| permissions\_boundary | If provided, all IAM roles will be created with this permissions boundary attached. | `string` | `null` | no |
| public\_access\_cidrs | Indicates which CIDR blocks can access the Amazon EKS public API server endpoint when enabled. EKS defaults this to a list with 0.0.0.0/0. | `list(string)` | <pre>[<br>  "0.0.0.0/0"<br>]</pre> | no |
| repository | Terraform current module repo | `string` | `"https://github.com/clouddrove/terraform-aws-eks"` | no |
| schedules | Map of autoscaling group schedule to create | `map(any)` | `{}` | no |
| self\_node\_group\_defaults | Map of self-managed node group default configurations | `any` | `{}` | no |
| self\_node\_groups | Map of self-managed node group definitions to create | `any` | `{}` | no |
| subnet\_ids | A list of subnet IDs to launch the cluster in. | `list(string)` | `[]` | no |
| tags | Additional tags (e.g. map(`BusinessUnit`,`XYZ`). | `map(any)` | `{}` | no |
| vpc\_id | VPC ID for the EKS cluster. | `string` | `""` | no |
| vpc\_security\_group\_ids | A list of security group IDs to associate | `list(string)` | `[]` | no |
| wait\_for\_cluster\_command | `local-exec` command to execute to determine if the EKS cluster is healthy. Cluster endpoint are available as environment variable `ENDPOINT` | `string` | `"curl --silent --fail --retry 60 --retry-delay 5 --retry-connrefused --insecure --output /dev/null $ENDPOINT/healthz"` | no |

## Outputs

| Name | Description |
|------|-------------|
| cluster\_arn | The Amazon Resource Name (ARN) of the cluster |
| cluster\_certificate\_authority\_data | Base64 encoded certificate data required to communicate with the cluster |
| cluster\_endpoint | Endpoint for your Kubernetes API server |
| cluster\_iam\_role\_arn | IAM role ARN of the EKS cluster |
| cluster\_iam\_role\_name | IAM role name of the EKS cluster |
| cluster\_iam\_role\_unique\_id | Stable and unique string identifying the IAM role |
| cluster\_id | The name/id of the EKS cluster. Will block on cluster creation until the cluster is really ready |
| cluster\_name | n/a |
| cluster\_oidc\_issuer\_url | The URL on the EKS cluster for the OpenID Connect identity provider |
| cluster\_platform\_version | Platform version for the cluster |
| cluster\_primary\_security\_group\_id | Cluster security group that was created by Amazon EKS for the cluster. Managed node groups use default security group for control-plane-to-data-plane communication. Referred to as 'Cluster security group' in the EKS console |
| cluster\_status | Status of the EKS cluster. One of `CREATING`, `ACTIVE`, `DELETING`, `FAILED` |
| node\_group\_iam\_role\_arn | IAM role ARN of the EKS cluster |
| node\_group\_iam\_role\_name | IAM role name of the EKS cluster |
| node\_group\_iam\_role\_unique\_id | Stable and unique string identifying the IAM role |
| node\_security\_group\_arn | Amazon Resource Name (ARN) of the node shared security group |
| node\_security\_group\_id | ID of the node shared security group |
| oidc\_provider\_arn | The ARN of the OIDC Provider if `enable_irsa = true` |
| tags | n/a |




## Testing
In this module testing is performed with [terratest](https://github.com/gruntwork-io/terratest) and it creates a small piece of infrastructure, matches the output like ARN, ID and Tags name etc and destroy infrastructure in your AWS account. This testing is written in GO, so you need a [GO environment](https://golang.org/doc/install) in your system. 

You need to run the following command in the testing folder:
```hcl
  go test -run Test
```



## Feedback 
If you come accross a bug or have any feedback, please log it in our [issue tracker](https://github.com/clouddrove/terraform-aws-eks/issues), or feel free to drop us an email at [hello@clouddrove.com](mailto:hello@clouddrove.com).

If you have found it worth your time, go ahead and give us a ★ on [our GitHub](https://github.com/clouddrove/terraform-aws-eks)!

## About us

At [CloudDrove][website], we offer expert guidance, implementation support and services to help organisations accelerate their journey to the cloud. Our services include docker and container orchestration, cloud migration and adoption, infrastructure automation, application modernisation and remediation, and performance engineering.

<p align="center">We are <b> The Cloud Experts!</b></p>
<hr />
<p align="center">We ❤️  <a href="https://github.com/clouddrove">Open Source</a> and you can check out <a href="https://github.com/clouddrove">our other modules</a> to get help with your new Cloud ideas.</p>

  [website]: https://clouddrove.com
  [github]: https://github.com/clouddrove
  [linkedin]: https://cpco.io/linkedin
  [twitter]: https://twitter.com/clouddrove/
  [email]: https://clouddrove.com/contact-us.html
  [terraform_modules]: https://github.com/clouddrove?utf8=%E2%9C%93&q=terraform-&type=&language=
